{
    email soporte@chilldigital.tech
    servers {
        max_header_size 1MB
    }
}

odonto.chilldigital.tech {
    # --- CORS preflight (OPTIONS) ---
    @cors_preflight {
        method OPTIONS
        path /api/*
    }
    header @cors_preflight {
        Access-Control-Allow-Origin "https://odonto.chilldigital.tech"
        Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
        Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With, X-CSRF-Token"
        Access-Control-Allow-Credentials "true"
        Access-Control-Max-Age "86400"
    }
    respond @cors_preflight 204

    # --- Proxy a n8n: /api/* -> /webhook{path} ---
    handle_path /api/* {
        reverse_proxy https://n8n.chilldigital.tech/webhook{path} {
            header_up Host "n8n.chilldigital.tech"
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
            header_up X-Forwarded-Host {host}
            header_up User-Agent "DentalPro-Frontend/2.0"

            # CORS en respuestas reales de la API
            header_down Access-Control-Allow-Origin "https://odonto.chilldigital.tech"
            header_down Access-Control-Allow-Credentials "true"

            transport http {
                dial_timeout 30s
                response_header_timeout 30s
            }
        }
    }

    # --- Archivos estáticos (SPA) ---
    root * /usr/share/caddy

    # Encabezados de seguridad (UNA sola línea cada uno)
    header {
        Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; img-src 'self' data: https:; font-src 'self' https://cdn.jsdelivr.net; connect-src 'self' https://n8n.chilldigital.tech; object-src 'none'; base-uri 'self'; form-action 'self';"
        X-Frame-Options "SAMEORIGIN"
        X-Content-Type-Options "nosniff"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        Strict-Transport-Security "max-age=31536000; includeSubDomains"
        Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=(), magnetometer=(), gyroscope=(), speaker=()"
        -Server
    }

    # Caché
    @static {
        path *.css *.js *.png *.jpg *.jpeg *.gif *.ico *.svg *.woff *.woff2 *.ttf *.eot *.webp
    }
    header @static {
        Cache-Control "public, max-age=31536000, immutable"
        Vary "Accept-Encoding"
    }
    @html {
        path *.html
    }
    header @html {
        Cache-Control "no-cache, no-store, must-revalidate"
        Pragma "no-cache"
        Expires "0"
    }

    # Compresión + SPA fallback
    encode gzip
    try_files {path} {path}/ /index.html
    file_server

    # Logs
    log {
        output file /var/log/caddy/access.log {
            roll_size 100mb
            roll_keep 5
        }
        format console
        level INFO
    }
}

# --- Bloque de DEV opcional (activá solo en entorno de pruebas) ---
# localhost:80 {
#     @cors_preflight {
#         method OPTIONS
#         path /api/*
#     }
#     header @cors_preflight {
#         Access-Control-Allow-Origin "http://localhost"
#         Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
#         Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With, X-CSRF-Token"
#         Access-Control-Allow-Credentials "true"
#         Access-Control-Max-Age "86400"
#     }
#     respond @cors_preflight 204
#
#     handle_path /api/* {
#         reverse_proxy https://n8n.chilldigital.tech/webhook{path}
#     }
#     root * /usr/share/caddy
#     encode gzip
#     try_files {path} {path}/ /index.html
#     file_server
# }
