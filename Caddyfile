{
    email soporte@chilldigital.tech
    servers {
        max_header_size 1MB
    }
}

odonto.chilldigital.tech {
    # Manejo de preflight CORS
    @cors_preflight {
        method OPTIONS
        path /api/*
    }
    respond @cors_preflight 204 {
        header {
            Access-Control-Allow-Origin "https://odonto.chilldigital.tech"
            Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
            Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With, X-CSRF-Token"
            Access-Control-Allow-Credentials "true"
            Access-Control-Max-Age "86400"
        }
    }

    # Proxy reverso a N8N (quita /api y agrega /webhook)
    handle_path /api/* {
        reverse_proxy https://n8n.chilldigital.tech/webhook{path} {
            header_up Host "n8n.chilldigital.tech"
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
            header_up X-Forwarded-Host {host}
            header_up User-Agent "DentalPro-Frontend/2.0"
            header_down Access-Control-Allow-Origin "https://odonto.chilldigital.tech"
            header_down Access-Control-Allow-Credentials "true"
            transport http {
                dial_timeout 30s
                response_header_timeout 30s
            }
        }
    }

    # Archivos estáticos (SPA)
    root * /usr/share/caddy

    # Encabezados de seguridad globales
    header {
        Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; img-src 'self' data: https:; font-src 'self' https://cdn.jsdelivr.net; connect-src 'self' https://n8n.chilldigital.tech; object-src 'none'; base-uri 'self'; form-action 'self';"
        X-Frame-Options "SAMEORIGIN"
        X-Content-Type-Options "nosniff"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        Strict-Transport-Security "max-age=31536000; includeSubDomains"
        Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=(), magnetometer=(), gyroscope=(), speaker=()"
        -Server
    }

    # Políticas de caché
    @static {
        path *.css *.js *.png *.jpg *.jpeg *.gif *.ico *.svg *.woff *.woff2 *.ttf *.eot *.webp
    }
    header @static {
        Cache-Control "public, max-age=31536000, immutable"
        Vary "Accept-Encoding"
    }
    @html {
        path *.html
    }
    header @html {
        Cache-Control "no-cache, no-store, must-revalidate"
        Pragma "no-cache"
        Expires "0"
    }

    # Compresión y servicio de archivos
    encode gzip
    try_files {path} {path}/ /index.html
    file_server

    # Logging de accesos
    log {
        output file /var/log/caddy/access.log {
            roll_size 100mb
            roll_keep 5
        }
        format console
        level INFO
    }
}

# (Opcional) Bloque de desarrollo local - comentar o activar solo en entorno de pruebas
# localhost:80 {
#     handle_path /api/* {
#         reverse_proxy https://n8n.chilldigital.tech/webhook{path} {
#             header_up Host "n8n.chilldigital.tech"
#             header_up X-Real-IP {remote_host}
#             header_up X-Forwarded-For {remote_host}
#             header_up X-Forwarded-Proto {scheme}
#             header_up X-Forwarded-Host {host}
#         }
#     }
#     root * /usr/share/caddy
#     encode gzip
#     try_files {path} {path}/ /index.html
#     file_server
# }
